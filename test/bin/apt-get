#! /usr/bin/python

import argparse
import os
import re
import subprocess
import sys

import jrw.wrapper as wrapper

def main():
  if sys.argv[1:2] == ['source']:
    DoMagic()
  else:
    wrapper.ExecWrappedProgram()

def DoMagic():
  parser = argparse.ArgumentParser()
  parser.add_argument("package")
  args = parser.parse_args(sys.argv[2:])

  proc = subprocess.Popen(
      [wrapper.FindWrappedProgram(), 'source', args.package],
      stdout=subprocess.PIPE)
  tag_name = None
  for line in proc.stdout:
    sys.stdout.write(line)
    m = re.match(r'dpkg-source: info: extracting (\S+) in (\S+)\n', line)
    if m and m.group(1) == args.package:
      tag_name = m.group(2)
  proc.wait()

  if not tag_name:
    sys.exit('Can\'t determine output directory!')

  output_dir = os.path.abspath(tag_name)
  subprocess.check_call(
      ['git', 'init'], cwd=output_dir)
  subprocess.check_call(
      ['git', 'add', '.'], cwd=output_dir)
  message = 'Pristine copy from "apt-get source"'
  subprocess.check_call(
      ['git', 'commit', '-m', message], cwd=output_dir)
  subprocess.check_call(
      ['git', 'tag', tag_name], cwd=output_dir)

  print 'Created a new git repository in %s' % tag_name

main()
