#! /bin/bash

# This script installs git hooks that link to scripts in the githooks
# directory.

set -e

start_dir=$PWD
git_dir=$(git rev-parse --git-dir)
cd "$git_dir"
git_dir=$PWD

cd "$start_dir"
cd "$(dirname "$0")"
script_dir=$PWD
if [[ $script_dir = $HOME/* ]]; then
  script_dir_ref='$HOME/'$(shquote -- "${script_dir#$HOME/}")
else
  script_dir_ref=$(shquote -- "$script_dir")
fi

if [[ -e "$git_dir/hooks/README.githooks" && $1 != -f ]]; then
  echo "Git hooks already installed.  Manually delete $git_dir/hooks before re-installing." >&2
  exit 1
fi

hook_names='applypatch-msg commit-msg post-checkout post-update pre-applypatch pre-commit prepare-commit-msg pre-rebase update'

rm -rf "$git_dir/hooks"
mkdir "$git_dir/hooks"
echo "This directory was created by $0" > "$git_dir/hooks/README.githooks"
for name in $hook_names; do
  if [[ -e $git_dir/hooks/$name ]]; then
    mv "$git_dir/hooks/$name" "$git_dir/hooks/$name.local"
  fi
  cat >"$git_dir/hooks/$name" <<EOF
#! /bin/bash
# Script generated by $0
exec "$script_dir_ref/githooks/runhook" $name "\$@"
EOF
  chmod +x "$git_dir/hooks/$name"
done
