#! /bin/bash

# Script to be running at all times on each host where the owner is
# logged in.

set -e
IFS=

on_exit() {
  rm -f $XDG_RUNTIME_DIR/jrw/per_host_pid
}

record_pid() {
  mkdir -p $XDG_RUNTIME_DIR/jrw
  echo $$ > $XDG_RUNTIME_DIR/jrw/per_host_pid
}

echo_pid() {
  local pid=
  if [[ -f $XDG_RUNTIME_DIR/jrw/per_host_pid ]]; then
    pid=$(cat $XDG_RUNTIME_DIR/jrw/per_host_pid)
  fi
  if [[ $pid && -d /proc/$pid &&
          $(cat /proc/$pid/cmdline) == *$HOME/bin/per_host* ]]; then
    echo $pid
    return 0
  fi
  return 1
}

stop_if_other_instance() {
  if echo_pid >/dev/null; then
    exit 0
  fi
}

kill_other_instance() {
  if local pid=$(echo_pid); then
    kill $pid
  fi
}

main() {
  if [[ $1 == --restart ]]; then
    kill_other_instance
  else
    stop_if_other_instance
  fi
  trap on_exit 0
  record_pid
  sleep 5
}

main $@
